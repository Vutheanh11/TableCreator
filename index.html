<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Khối Lượng Tự Động</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <!-- Desktop Entry Form (Outside wrapper for print) -->
    <div class="desktop-entry-form no-print">
        <h3>Nhập Thông Tin Hàng Hóa</h3>
        <div class="form-row">
            <div class="form-field">
                <label>Tên Hàng</label>
                <textarea id="desktopItemName" rows="2" placeholder="Nhập tên hàng"></textarea>
            </div>
            <div class="form-field">
                <label>Kích Thước</label>
                <input type="text" id="desktopItemSize" placeholder="VD: 330x120" onblur="formatDesktopDimension(this)">
            </div>
            <div class="form-field">
                <label>Số Lượng</label>
                <input type="text" id="desktopItemQuantity" placeholder="Tự động hoặc nhập thủ công" oninput="handleDesktopQuantityInput(this)">
            </div>
            <div class="form-field">
                <label>Đơn Giá</label>
                <input type="text" id="desktopItemPrice" placeholder="Nhập đơn giá" onblur="formatDesktopPrice(this)" onfocus="removeDesktopPriceFormat(this)">
            </div>
            <div class="form-field">
                <label>Thành Tiền</label>
                <div class="form-total" id="desktopItemTotal">0</div>
            </div>
            <div class="form-field">
                <button onclick="addDesktopEntry()" class="add-entry-btn">➕ Thêm Vào Bảng</button>
            </div>
        </div>
    </div>

    <div class="wrapper">
        <div class="controls">
            <button onclick="addRow()" class="add-btn">Thêm Hàng</button>
            <button onclick="toggleEditMode()" class="print-btn" id="editModeBtn" style="background-color: #9C27B0;">Chỉnh Bảng</button>
            <button onclick="printTable()" class="print-btn">In</button>
            <button onclick="exportToExcel()" class="excel-btn">Xuất Excel</button>
            <button onclick="document.getElementById('excelFileInput').click()" class="load-btn">Load Excel</button>
            <input type="file" id="excelFileInput" accept=".xlsx, .xls" style="display: none;" onchange="loadFromExcel(event)">
            <button onclick="clearTable()" class="delete-btn">Xóa Tất Cả</button>
            <button onclick="window.location.href='BangBaoGia.html'" class="print-btn" style="background-color: #9C27B0;">Bảng Báo Giá</button>
            <button onclick="showHelp()" class="help-btn">Cách sử dụng</button>
        </div>
        
        <div class="container">
            <div class="editable-header">
                <input type="text" id="companyName" placeholder="Tên công ty" value="CTY TNHH TRƯỜNG GIANG WINDOWS">
                <input type="text" id="companyTax" placeholder="MST" value="MST:1702262181">
                <input type="text" id="companyAddress" placeholder="Địa chỉ" value="Đ/C: P45, căn 19, khu đô thị Phú Cường, phường An Hoà, TP.Rạch Giá, Kiên Giang">
                <input type="text" id="companyPhone" placeholder="SĐT" value="SĐT: 0919808309">
            </div>

            <div class="header">
                <div class="title">BẢNG KHỐI LƯỢNG</div>
                <div class="subtitle">
                    <span>Kính gửi quý khách hàng: <input type="text" id="customerName" placeholder="Nhập tên" value="" style="border: none; padding: 2px 5px; min-width: 150px; background: transparent; font-style: italic; font-size: 16px; font-family: 'Times New Roman', serif;"></span>
                </div>
            </div>

        <table id="priceTable">
            <thead>
                <tr>
                    <th style="width: 50px;">STT</th>
                    <th style="width: 250px;">Tên Hàng</th>
                    <th style="width: 180px;">Kích Thước</th>
                    <th style="width: 120px;">Số Lượng</th>
                    <th style="width: 120px;">Đơn Giá</th>
                    <th style="width: 140px;">Thành Tiền</th>
                    <th style="width: 100px;" class="no-print">Thao Tác</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- Rows will be added here -->
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="5" style="text-align: left; padding-left: 20px;">Tổng Cộng</td>
                    <td id="grandTotal" style="text-align: center;">0</td>
                    <td class="no-print"></td>
                </tr>
                <tr class="discount-row" id="discountRow" style="display: none;">
                    <td colspan="5" style="text-align: left; padding-left: 20px;">Chiết Khấu (<span id="discountDisplay">0%</span>)</td>
                    <td id="discountAmount" style="text-align: center;">0</td>
                    <td class="no-print"></td>
                </tr>
                <tr class="vat-row" id="vatRow" style="display: none;">
                    <td colspan="5" style="text-align: left; padding-left: 20px;">VAT (<span id="vatPercent">10</span>%)</td>
                    <td id="vatAmount" style="text-align: center;">0</td>
                    <td class="no-print"></td>
                </tr>
                <tr class="paid-row" id="paidRow" style="display: none;">
                    <td colspan="5" style="text-align: left; padding-left: 20px;">Đã Thu</td>
                    <td><input type="text" id="paidAmount" value="0" onblur="formatPaidAmount(this)" onfocus="removePaidFormat(this)" onchange="updateTotals()" oninput="updateTotals()" style="text-align: center; font-weight: bold;"></td>
                    <td class="no-print"></td>
                </tr>
                <tr class="final-row" id="finalRow" style="display: none;">
                    <td colspan="5" style="text-align: left; padding-left: 20px;"><strong>Tổng Thanh Toán</strong></td>
                    <td id="finalTotal" style="text-align: center;"><strong>0</strong></td>
                    <td class="no-print"></td>
                </tr>
            </tfoot>
        </table>
        
        <!-- VAT and Discount Controls -->
        <div class="calculation-controls no-print">
            <div class="control-group">
                <label>
                    <input type="checkbox" id="enableVAT" onchange="toggleVAT()">
                    <span>Tính VAT</span>
                </label>
                <input type="number" id="vatValue" value="10" min="0" max="100" step="1" onchange="updateTotals()" oninput="updateTotals()" style="width: 60px; margin-left: 10px;"> %
            </div>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="enableDiscount" onchange="toggleDiscount()">
                    <span>Chiết khấu</span>
                </label>
                <input type="number" id="discountValue" value="0" min="0" step="0.1" onchange="updateTotals()" oninput="updateTotals()" style="width: 80px; margin-left: 10px;">
                <select id="discountType" onchange="updateTotals()" style="margin-left: 5px;">
                    <option value="percent">%</option>
                    <option value="fixed">VNĐ</option>
                </select>
            </div>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="enablePaid" onchange="togglePaid()">
                    <span>Đã thu</span>
                </label>
            </div>
        </div>
    </div>
    </div>

    <!-- Floating Action Button for Mobile -->
    <div class="fab-container">
        <input type="checkbox" id="fabCheckbox" onchange="toggleFabMenu(event)">
        <label for="fabCheckbox" class="fab-button">
            <div class="bars" id="bar1"></div>
            <div class="bars" id="bar2"></div>
            <div class="bars" id="bar3"></div>
        </label>
    </div>
    <div id="fabMenu" class="fab-menu">
        <button onclick="addRow()" class="add-btn">Thêm Hàng</button>
        <button onclick="toggleEditMode(); toggleFabMenu()" class="print-btn" id="editModeBtnMobile" style="background-color: #9C27B0;">Chỉnh Bảng</button>
        <button onclick="exportToPDF_Mobile(); toggleFabMenu()" class="print-btn" style="background-color: #E91E63;">Xuất PDF</button>
        <button onclick="exportToExcel(); toggleFabMenu()" class="excel-btn">Xuất Excel</button>
        <button onclick="document.getElementById('excelFileInput').click(); toggleFabMenu()" class="load-btn">Load Excel</button>
        <button onclick="clearTable(); toggleFabMenu()" class="delete-btn">Xóa Tất Cả</button>
        <button onclick="window.location.href='BangBaoGia.html'" class="print-btn" style="background-color: #9C27B0;">Bảng Báo Giá</button>
        <button onclick="showHelp(); toggleFabMenu()" class="help-btn">Cách sử dụng</button>
    </div>

    <!-- Modal Hướng dẫn -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeHelp()">&times;</span>
            <h2>Hướng dẫn sử dụng</h2>
            <div class="help-content">
                <h3>1. Nhập thông tin công ty:</h3>
                <p>- Chỉnh sửa tên công ty, MST, địa chỉ, số điện thoại ổ phía trên</p>
                <p>- Nhập tên khách hàng vào ô sau "Kính gửi quý khách hàng:"</p>
                
                <h3>2. Thêm hàng hóa:</h3>
                <p>- Nhấn nút "Thêm Hàng" để thêm dòng mới</p>
                <p>- Nhập tên hàng, kích thước, số lượng, đơn giá</p>
                
                <h3>3. Kích thước tự động:</h3>
                <p>- Nhập: <strong>330 x 120</strong> → Tự động chuyển thành: <strong>3m30 x 1m20</strong></p>
                <p>- Hỗ trợ số thập phân: <strong>309,8 x 295,6</strong> → <strong>3m09,8 x 2m95,6</strong></p>
                <p>- Phép cộng: <strong>450 + 75</strong> → <strong>4m50 + 75cm</strong></p>
                
                <h3>4. Số lượng tự động tính:</h3>
                <p>- Khi nhập kích thước và nhấn Tab, số lượng sẽ tự động tính</p>
                <p>- Ví dụ: <strong>3m30 x 1m20</strong> = <strong>3m96</strong> (diện tích)</p>
                
                <h3>5. Đơn giá:</h3>
                <p>- Nhập số thuần, tự động format: <strong>5100000</strong> → <strong>5.100.000</strong></p>
                
                <h3>6. In và Lưu:</h3>
                <p>- Nhấn nút "In" để in hoặc lưu PDF</p>
                <p>- Nhấn "Xóa Tất Cả" để làm mới bảng</p>
            </div>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content confirm-modal">
            <h3 id="confirmMessage">Bạn có chắc chắn?</h3>
            <div class="confirm-buttons">
                <button onclick="confirmAction(true)" class="confirm-yes">Xác nhận</button>
                <button onclick="confirmAction(false)" class="confirm-no">Hủy</button>
            </div>
        </div>
    </div>

    <!-- PDF Orientation Modal -->
    <div id="pdfOrientationModal" class="modal">
        <div class="modal-content confirm-modal">
            <h3>Chọn hướng xuất PDF</h3>
            <div class="confirm-buttons">
                <button onclick="confirmPDFOrientation('portrait')" class="confirm-yes">Dọc</button>
                <button onclick="confirmPDFOrientation('landscape')" class="print-btn">Ngang</button>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeHistory()">&times;</span>
            <h2>Lịch Sử Báo Giá</h2>
            <div style="margin-bottom: 15px;">
                <input type="text" id="historySearch" placeholder="Tìm kiếm theo tên khách hàng..." onkeyup="filterHistory()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div id="historyList" style="max-height: 400px; overflow-y: auto;">
                <!-- History items will be added here -->
            </div>
            <div style="margin-top: 15px; text-align: center;">
                <button onclick="clearHistory()" class="delete-btn">Xóa Toàn Bộ Lịch Sử</button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script src="mobile-functions.js"></script>
</body>
</html>